<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiwik - Learn Languages Through Music</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'VCR OSD Neue', sans-serif;
            background-color: #0a0909;
            color: rgb(9, 248, 168);
            min-height: 100vh;
        }

        @font-face {
        font-family: 'VCR OSD Neue';  /* Name you want to use for the font */
        src: url('css/VCRosdNEUE.ttf') format('truetype'); /* Path to your .ttf file */
        font-weight: normal;
        font-style: normal;
        }

        /* Header */
        header {
            padding: 1rem;
            position: relative;
            background-color:rgb(9, 248, 168);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color:rgb(9, 9, 9)
        }

        .hamburger {
            display: flex;
            flex-direction: column;
            cursor: pointer;
            gap: 3px;
        }

        .hamburger span {
            width: 25px;
            height: 3px;
            background-color: #0a0a0a;
            transition: 0.3s;
        }

        .nav-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color:rgb(8, 220, 149);
            transform: translateY(-100%);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .nav-menu.active {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }

        .nav-menu ul {
            list-style: none;
            padding: 1rem;
        }

        .nav-menu li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #070d0c;
        }

        .nav-menu li:last-child {
            border-bottom: none;
        }

        .nav-menu a {
            color: #100e0e;
            text-decoration: none;
        }

        /* Main Content */
        main {
            padding: 2rem 1rem 0;
        }

        .hero-text {
            font-size: 1.2rem;
            line-height: 1.6;
            margin-bottom: 3rem;
            text-align: center;
        }
        /* .hero-text title {
            font-size: 5vw;
            line-height: 1.6;
            margin-bottom: 3rem;
            text-align: center;
        }
        .hero-text body {
            font-size: 1.2rem;
            line-height: 1.6;
            margin-bottom: 3rem;
            text-align: center;
        } */

        .target-language {
            font-size: 1.1rem;
            background: #cbcaca;
            color:#0c0d0d;
            margin-bottom: 1rem;
            padding: 0.5rem;
            position: relative;
        }

        /* .target-language::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100vw;
            height: 2px;
            background-color: #ffffff;
        } */


        .vids {
            display: flex;
            justify-content: center; /* Horizontal centering */
            align-items: center;    /* Vertical centering */
            gap: 50px;
            margin-bottom: 50px;
        }

        .how-works {
            display: flex;
            justify-content: center; /* Horizontal centering */
            align-items: center;    /* Vertical centering */
            height: 200px; 
        }   

        .how-to {
            display: flex;
            justify-content: center; /* Horizontal centering */
            align-items: center;    /* Vertical centering */
            height: 200px; 
        }



        /* Song Cards */
        .songs-section {
            padding: 2rem 1rem 2rem;
        }

        .songs-grid {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: 1fr;
        }

        .song-item {
            display: flex;
            flex-direction: column;
        }

        .song-card {
            background-color: #b8d4d1;
            width: 100%;
            aspect-ratio: 16 / 9;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .song-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .song-info {
            background-color: #ffffff;
            color: #2a3f3b;
            padding: 1rem;
            text-align: center;
        }

        .song-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .song-artist {
            font-size: 1rem;
        }

        /* Desktop Styles */
        @media (min-width: 768px) {
            .hamburger {
                display: none;
            }

            .nav-menu {
                position: static;
                transform: none;
                opacity: 1;
                visibility: visible;
                background: none;
            }

            .nav-menu ul {
                display: flex;
                gap: 2rem;
                padding: 0;
            }

            .nav-menu li {
                border: none;
                padding: 0;
            }

            main {
                padding: 3rem 2rem;
            }

            .hero-text {
                font-size: 1.5rem;
                margin-bottom: 4rem;
            }

            .songs-section {
                padding: 0 2rem 3rem;
            }

            .songs-grid {
                grid-template-columns: 1fr 1fr;
                gap: 2rem;
            }

            .song-card {
                aspect-ratio: 16 / 9;
            }

        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">FrazeKraze</div>
            <div class="hamburger" id="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <nav class="nav-menu" id="navMenu">
                <ul>
                    <li><a href="#about">about</a></li>
                    <li><a href="#language">native: English</a></li>
                    <li><a href="#" onclick="openAuthModal()">log in</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <div class="hero-text">
            <!-- <h3>The only really fun and efficient way to learn a language</h3> -->
        
            <h2>F R A Z E - K R A Z E</h2>
            <h3>Beat your favourite songs' vocabulary</h3>

            </div>

            <div class="vids">
                <div class="how-works"><h3>How this works</h3>
                <div class="video-tutorial"></div>
                </div>
                <div class="how-to"><h3>How to Play</h3>
                <div class="video-tutorial"></div>
                </div>
            </div>

        
    </main>

    <section class="songs-section">
        <div class="target-language">playing in... Fran√ßais</div>
        <div class="songs-grid">
            <div class="song-item">
                <div class="song-card" onclick="launchGame('la_fievre_beginner')"><img src="assets/images/la-fievre.png"></div>
                <div class="song-info">
                    <div class="song-title">La fi√®vre</div>
                    <div class="song-artist">Julien Dor√©</div>
                </div>
            </div>
            <div class="song-item">
                <div class="song-card" onclick="launchGame('grande_deception')"><img src="assets/images/la-symphonie-des-eclairs.png"></div>
                <div class="song-info">
                    <div class="song-title">La symphonie des √©clairs</div>
                    <div class="song-artist">La Grande D√©ception</div>
                </div>
            </div>
            <div class="song-item">
                <div class="song-card" onclick="launchGame('game_1')"><img src="assets/images/la-symphonie-des-eclairs.png"></div>
                <div class="song-info">
                    <div class="song-title">La symphonie des √©clairs </div>
                    <div class="song-artist">Le Myst√®re des Livres vol√©s. Premiere partie</div>
                </div>
            </div>
        </div>
    </section>

    <script>
        const hamburger = document.getElementById('hamburger');
        const navMenu = document.getElementById('navMenu');

        hamburger.addEventListener('click', () => {
            navMenu.classList.toggle('active');
        });


    // SECURE VERSION: Modified launchGame function with authentication gate
    function launchGame(songId) {
        console.log('üéÆ LaunchGame: Attempting to launch game for:', songId);
        
        // SECURITY CHECK: Verify user is authenticated before allowing game access
        if (!currentUser) {
            console.log('üîê LaunchGame: User not authenticated, opening auth modal');
            
            // Store the song they wanted to play for after login
            localStorage.setItem('pendingGame', songId);
            
            // Show authentication modal instead of launching game
            openAuthModal();
            return;
        }
        
        console.log('‚úÖ LaunchGame: User authenticated, launching game for:', currentUser.email);
        
        // Store the selected song for the game
        localStorage.setItem('selectedSong', songId);
        
        // Clear any pending game (in case this was called after auth)
        localStorage.removeItem('pendingGame');
        
        // Navigate to the game - now secured!
        window.location.href = 'game.html';
    }
    </script>

    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>

    <!-- Firebase and Auth Scripts -->
    <script src="js/managers/FirebaseAdapter.js"></script>
    <script src="js/managers/AuthManager.js"></script>
    <script src="js/core/EventBus.js"></script>

    <script>
    // Initialize auth system for launcher
    let eventBus, firebaseAdapter, authManager;
    let currentUser = null;

    document.addEventListener('DOMContentLoaded', () => {
        console.log('üöÄ Launcher: Initializing authentication...');
        
        // Initialize components
        eventBus = new EventBus();
        firebaseAdapter = new FirebaseAdapter();
        authManager = new AuthManager(eventBus, firebaseAdapter);
        
        // Setup auth event listeners
        setupAuthEventListeners();
        
        console.log('‚úÖ Launcher: Authentication initialized');
    });

    function setupAuthEventListeners() {
        // Listen for auth state changes
        eventBus.on('auth:statusChanged', (data) => {
            console.log('üîê Launcher: Auth status changed:', data.isAuthenticated ? 'logged in' : 'logged out');
            currentUser = data.user;
            updateMenuAuthState(data.isAuthenticated, data.user);
            
            // NEW: Auto-launch pending game after authentication
            if (data.isAuthenticated) {
                const pendingGame = localStorage.getItem('pendingGame');
                if (pendingGame) {
                    console.log('üéÆ Launcher: Auto-launching pending game:', pendingGame);
                    setTimeout(() => {
                        launchGame(pendingGame);
                    }, 500); // Small delay to ensure UI is ready
                }
            }
        });
        
        // Handle successful login
        eventBus.on('auth:loginSuccess', (data) => {
            console.log('‚úÖ Launcher: Login successful');
            closeAuthModal();
            showAuthSuccess('Welcome back!');
            
            // NEW: Check for pending game launch
            const pendingGame = localStorage.getItem('pendingGame');
            if (pendingGame) {
                showAuthSuccess('Launching your game...');
            }
        });
        
        // Handle successful registration
        eventBus.on('auth:registerSuccess', (data) => {
            console.log('‚úÖ Launcher: Registration successful');
            closeAuthModal();
            showAuthSuccess('Account created successfully!');
            
            // NEW: Check for pending game launch
            const pendingGame = localStorage.getItem('pendingGame');
            if (pendingGame) {
                showAuthSuccess('Welcome! Launching your game...');
            }
        });
        
        // Handle login errors
        eventBus.on('auth:loginError', (data) => {
            console.log('‚ùå Launcher: Login error:', data.message);
            showAuthError(data.message);
            setAuthLoading(false);
        });
        
        // Handle registration errors
        eventBus.on('auth:registerError', (data) => {
            console.log('‚ùå Launcher: Registration error:', data.message);
            showAuthError(data.message);
            setAuthLoading(false);
        });
        
        // Handle logout success
        eventBus.on('auth:logoutSuccess', () => {
            console.log('‚úÖ Launcher: Logout successful');
            showAuthSuccess('Logged out successfully!');
            
            // NEW: Clear any pending games on logout
            localStorage.removeItem('pendingGame');
        });
    }

    // Global auth functions
    function openAuthModal() {
        console.log('üîê Launcher: Opening auth modal...');
        
        // Load auth template
        fetch('templates/screens/auth.html')
            .then(response => {
                console.log('‚úÖ Fetch response received:', response.status);
                return response.text();
            })
            .then(html => {
                console.log('‚úÖ HTML content loaded, length:', html.length);
                console.log('‚úÖ First 100 chars:', html.substring(0, 100));
                
                // Create overlay container
                const overlay = document.createElement('div');
                overlay.id = 'authModalContainer';
                console.log('‚úÖ Overlay element created:', overlay);
                
                overlay.innerHTML = html;
                console.log('‚úÖ HTML content set to overlay');
                
                // Add to body
                document.body.appendChild(overlay);
                console.log('‚úÖ Overlay appended to body');
                
                // Check if it's actually in the DOM
                const check = document.getElementById('authModalContainer');
                console.log('‚úÖ DOM check after insertion:', !!check);
                
                // Focus on email field
                setTimeout(() => {
                    const emailField = document.getElementById('email');
                    console.log('‚úÖ Email field found:', !!emailField);
                    if (emailField) emailField.focus();
                }, 100);
                
                console.log('‚úÖ Launcher: Auth modal opened');
            })
            .catch(error => {
                console.error('‚ùå Launcher: Error loading auth modal:', error);
                alert('Error loading login form. Please refresh and try again.');
            });
    }

    function closeAuthModal() {
        console.log('üîê Launcher: Closing auth modal...');
        
        const container = document.getElementById('authModalContainer');
        if (container) {
            container.remove();
            console.log('‚úÖ Launcher: Auth modal closed');
        }
    }

    function login(email, password) {
        console.log('üîê Launcher: Attempting login...');
        
        // Show loading state
        setAuthLoading(true);
        hideAuthError();
        
        // Emit login event
        eventBus.emit('auth:login', { email, password });
    }

    function register(email, password, username) {
        console.log('üîê Launcher: Attempting registration...');
        
        // Show loading state
        setAuthLoading(true);
        hideAuthError();
        
        // Emit register event
        eventBus.emit('auth:register', { email, password, username });
    }

    function logout() {
        console.log('üîê Launcher: Attempting logout...');
        
        if (confirm('Are you sure you want to log out?')) {
            eventBus.emit('auth:logout');
        }
    }

    // Update menu based on auth state
    function updateMenuAuthState(isAuthenticated, user) {
        const navMenu = document.querySelector('.nav-menu ul');
        if (!navMenu) return;
        
        // Find the login menu item
        const loginItem = navMenu.querySelector('li:last-child');
        if (!loginItem) return;
        
        if (isAuthenticated && user) {
            // Show user email and logout option
            const userEmail = user.email;
            const displayEmail = userEmail.length > 20 ? userEmail.substring(0, 17) + '...' : userEmail;
            
            loginItem.innerHTML = `<a href="#" onclick="logout()">${displayEmail} | log out</a>`;
        } else {
            // Show login option
            loginItem.innerHTML = `<a href="#" onclick="openAuthModal()">log in</a>`;
        }
    }

    // Auth feedback functions
    function showAuthSuccess(message) {
        // Simple success message - you can enhance this
        const successDiv = document.createElement('div');
        successDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 4px;
            z-index: 10001;
            font-family: Arial, sans-serif;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        `;
        successDiv.textContent = message;
        
        document.body.appendChild(successDiv);
        
        // Remove after 3 seconds
        setTimeout(() => {
            if (successDiv.parentNode) {
                successDiv.parentNode.removeChild(successDiv);
            }
        }, 3000);
    }

    // These functions are called from the auth.html template
    function showAuthError(message) {
        const errorDiv = document.getElementById('authError');
        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
    }

    function hideAuthError() {
        const errorDiv = document.getElementById('authError');
        if (errorDiv) {
            errorDiv.style.display = 'none';
        }
    }

    function setAuthLoading(loading) {
        const submitBtn = document.getElementById('authSubmitBtn');
        const form = document.getElementById('authForm');
        
        if (submitBtn && form) {
            if (loading) {
                submitBtn.disabled = true;
                const isRegisterMode = document.getElementById('usernameField').style.display !== 'none';
                submitBtn.textContent = isRegisterMode ? 'Signing up...' : 'Logging in...';
                form.style.opacity = '0.7';
            } else {
                submitBtn.disabled = false;
                const isRegisterMode = document.getElementById('usernameField').style.display !== 'none';
                submitBtn.textContent = isRegisterMode ? 'Sign Up' : 'Log In';
                form.style.opacity = '1';
            }
        }
    }

    // Auth modal functions
    let isRegisterMode = false;

    function toggleAuthMode() {
        isRegisterMode = !isRegisterMode;
        
        const title = document.getElementById('authTitle');
        const inviteCodeField = document.getElementById('inviteCodeField');
        const usernameField = document.getElementById('usernameField');
        const submitBtn = document.getElementById('authSubmitBtn');
        const toggleText = document.getElementById('authToggleText');
        const toggleLink = document.getElementById('authToggleLink');
        
        if (isRegisterMode) {
            // Switch to register mode
            title.textContent = 'Sign Up';
            inviteCodeField.style.display = 'block';
            usernameField.style.display = 'block';
            submitBtn.textContent = 'Sign Up';
            toggleText.textContent = 'Already have an account?';
            toggleLink.textContent = 'Log in';
            
            // Make fields required in register mode
            document.getElementById('inviteCode').required = true;
            document.getElementById('username').required = true;
        } else {
            // Switch to login mode
            title.textContent = 'Log In';
            inviteCodeField.style.display = 'none';
            usernameField.style.display = 'none';
            submitBtn.textContent = 'Log In';
            toggleText.textContent = "Don't have an account?";
            toggleLink.textContent = 'Sign up';
            
            // Fields not required in login mode
            document.getElementById('inviteCode').required = false;
            document.getElementById('username').required = false;
        }
        
        // Clear any error messages
        hideAuthError();
        
        // Clear form
        document.getElementById('authForm').reset();
    }

    function handleAuthSubmit(event) {
        event.preventDefault();
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const username = document.getElementById('username').value;
        const inviteCode = document.getElementById('inviteCode').value;
        
        if (isRegisterMode) {
            // Validate invitation code ONLY for registration
            if (!inviteCode || inviteCode.toUpperCase() !== 'FRAZE-ALPHA-TEST') {
                showAuthError('Invalid invitation code. Please check your code and try again.');
                return;
            }
            
            register(email, password, username);
        } else {
            // Login - no invitation code needed
            login(email, password);
        }
    }
    </script>
</body>
</html>